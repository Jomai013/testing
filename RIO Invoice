/* testing for GitHUb*/

WITH MAIN AS(
SELECT Distinct

A.FONTE, A.LOTE, A.SERIE_DOC,RIGHT (B.CLIENTE_OWNER,6) AS CUSTOMER_NUMBER,A.NUM_DOC as INVOICE_NUMBER,B.DT_EMISS_DOC as INVOICE_DATE, B.VAL_INFO_DOC as INVOICE_AMOUNT_LC,A.CONTRATO as CONTRACTS, A.MINICODIGO, A.TIPO_ESTILO, 
A.SERIE,A.SERIAL_NBR, A.VALOR_ITEM,A.PROJECT_NUMBER,A.MCI,A.MCN,A.PEDIDO,
B.FILIAL,RIGHT(B.CLIENTE_OWNER,6)||A.NUM_DOC as CONNECTOR


FROM CCR2.LC2VB03 A
INNER JOIN CCR2.LC2VB02 B ON A.FONTE = B.FONTE AND A.NUM_DOC = B.NUM_DOC AND A.LOTE = B.LOTE  AND A.SERIE_DOC = B.SERIE_DOC

--CHANGE DATE HERE
WHERE B.DT_EMISS_DOC BETWEEN CURRENT DATE - ((DAY(CURRENT DATE)  - 1) DAYS)-1 MONTH AND CURRENT DATE - (DAY(CURRENT DATE) + 0) DAYS



AND A.STATUS_ITEM <> 'EX'                                          
                                            
AND A.MINICODIGO NOT IN ('AG0') 
AND A.MINICODIGO NOT LIKE 'K%' 
AND A.MINICODIGO NOT LIKE 'M%'                                                                                                            
AND B.LEDGER_CODE = '01'                                                                             
AND A. TIPO_REGISTRO ='20'

),
ADDTYPE AS(
Select Distinct

A.CUSTOMER, 
A.FATU,
A.DEMI as INVOICE_DATE,
A.VAL_TOT_FAT, 
A.ORCAMENTO AS CONTRACT, 
A.TIPO as TYPE,
A.MODELO as MODEL,
A.SERIE_MAQ as SERIAL,
A.MCI, 
A.MINICODIGO, 
A.NATOPER, 
A.LEDGER_CODE, 
A.VAL_ITEM_FAT, 
A.TIPO_DOC, 
A.CEP, 
A.CIFRA,
A.MES_REF, 
A.ANO_REF,

RIGHT(A.CUSTOMER,6)||A.FATU as CONNECTOR,
CASE WHEN ROW_NUMBER() OVER(PARTITION BY A.CUSTOMER,A.FATU) > 1 THEN 0
ELSE ROW_NUMBER() OVER(PARTITION BY A.CUSTOMER,A.FATU)
END	AS Unique_Flag_FATSERV
                     
                                                                 
FROM XDS2.FATSERVICO01 A

--CHANGE DATE HERE
WHERE A.DEMI BETWEEN CURRENT DATE - ((DAY(CURRENT DATE)  - 1) DAYS)-1 MONTH AND CURRENT DATE - (DAY(CURRENT DATE) + 0) DAYS

UNION

SELECT Distinct

B.CUSTOMER, 
B.FATU, 
B.DEMI AS INVOICE_DATE,
B.VAL_TOT_FAT, 
B.AGRENUM AS CONTRACT,
B."TYPE", 
B.MOD as MODEL, 
B.SERIAL,
B.MCI,
B.MINICODIGO, 
B.NATOPER, 
B.LEDGER_CODE, 
B.VAL_ITEM_FAT, 
B.TIPO_DOC, 
B.CEP, 
B.CIFRA,
B.MES_REF, 
B.ANO_REF ,

RIGHT(B.CUSTOMER,6)||B.FATU as CONNECTOR,
CASE WHEN ROW_NUMBER() OVER(PARTITION BY B.CUSTOMER,B.FATU) > 1 THEN 0
ELSE ROW_NUMBER() OVER(PARTITION BY B.CUSTOMER,B.FATU)
END	AS Unique_Flag_FATSERV             
                  
FROM XDS2.FATALUG01 B 

--CHANGE DATE HERE
WHERE B.DEMI BETWEEN CURRENT DATE - ((DAY(CURRENT DATE)  - 1) DAYS)-1 MONTH AND CURRENT DATE - (DAY(CURRENT DATE) + 0) DAYS
),



ADDTYPE2 as(

SELECT DISTINCT
A.*

FROM ADDTYPE A

Where
A.Unique_Flag_FATSERV = '1'
),


ADDTYPE3 as 
(

Select Distinct

A.*,
B."TYPE",
CASE WHEN ROW_NUMBER() OVER(PARTITION BY A.CUSTOMER_NUMBER,A.INVOICE_NUMBER) > 1 THEN 0
ELSE ROW_NUMBER() OVER(PARTITION BY A.CUSTOMER_NUMBER,A.INVOICE_NUMBER)
END	AS Unique_Flag_Invoice,
B.CEP, 
B.CIFRA,
B.MES_REF, 
B.ANO_REF,
B.NATOPER,

MONTH(A.INVOICE_DATE) as R_MONTH,
YEAR(A.INVOICE_DATE)as R_YEAR,
'BRL' as CURCODE


FROM MAIN A
LEFT JOIN ADDTYPE2 B 
ON B.CONNECTOR=A.CONNECTOR


),


WITHTYPE as
(select

A.FONTE,
A.LOTE,
A.SERIE_DOC,
A.CUSTOMER_NUMBER,
A.INVOICE_NUMBER,
A.INVOICE_DATE,
A.INVOICE_AMOUNT_LC,
A.CONTRACTS,
A.MINICODIGO,
A.TIPO_ESTILO,
A.SERIE,
A.SERIAL_NBR,
A.VALOR_ITEM,
A.PROJECT_NUMBER,
A.MCI,
A.MCN,
A.PEDIDO,
A.FILIAL,
A.CONNECTOR,
A."TYPE",
A.UNIQUE_FLAG_INVOICE,
A.CEP,
A.CIFRA,
A.MES_REF,
A.ANO_REF,
A.NATOPER,
A.R_MONTH,
A.R_YEAR,
A.CURCODE

FROM ADDTYPE3 A
Where 
A."TYPE" is not null
and trim(A."TYPE") not in ('0', '00', '000', '0000',' ')
),
NOTYPE as 
(
select

A.FONTE,
A.LOTE,
A.SERIE_DOC,
A.CUSTOMER_NUMBER,
A.INVOICE_NUMBER,
A.INVOICE_DATE,
A.INVOICE_AMOUNT_LC,
A.CONTRACTS,
A.MINICODIGO,
A.TIPO_ESTILO,
A.SERIE,
A.SERIAL_NBR,
A.VALOR_ITEM,
A.PROJECT_NUMBER,
A.MCI,
A.MCN,
A.PEDIDO,
A.FILIAL,
A.CONNECTOR,
A."TYPE",
A.UNIQUE_FLAG_INVOICE,
A.CEP,
A.CIFRA,
A.MES_REF,
A.ANO_REF,
A.NATOPER,
A.R_MONTH,
A.R_YEAR,
A.CURCODE

FROM ADDTYPE3 A
Where 
A."TYPE" is null
OR "TYPE" in ('0', '00', '000', '0000',' ')
)

Select Distinct


A.FONTE,
A.LOTE,
A.SERIE_DOC,
A.CUSTOMER_NUMBER,
A.INVOICE_NUMBER,
A.INVOICE_DATE,
A.INVOICE_AMOUNT_LC,
A.CONTRACTS,
A.MINICODIGO,
A.TIPO_ESTILO,
A.SERIE,
A.SERIAL_NBR,
A.VALOR_ITEM,
A.PROJECT_NUMBER,
A.MCI,
A.MCN,
A.PEDIDO,
A.FILIAL,
A.CONNECTOR,
CASE LEFT(A.TIPO_ESTILO,4)
WHEN ' ' THEN LEFT(A.TIPO_ESTILO,3)
ELSE LEFT(A.TIPO_ESTILO,4) 
END AS "TYPE",
A.UNIQUE_FLAG_INVOICE,
A.CEP,
A.CIFRA,
A.MES_REF,
A.ANO_REF,
A.NATOPER,
A.R_MONTH,
A.R_YEAR,
A.CURCODE
from NOTYPE A

--Where A.UNIQUE_FLAG_INVOICE = '1'

Union

select

A.FONTE,
A.LOTE,
A.SERIE_DOC,
A.CUSTOMER_NUMBER,
A.INVOICE_NUMBER,
A.INVOICE_DATE,
A.INVOICE_AMOUNT_LC,
A.CONTRACTS,
A.MINICODIGO,
A.TIPO_ESTILO,
A.SERIE,
A.SERIAL_NBR,
A.VALOR_ITEM,
A.PROJECT_NUMBER,
A.MCI,
A.MCN,
A.PEDIDO,
A.FILIAL,
A.CONNECTOR,
A."TYPE",
A.UNIQUE_FLAG_INVOICE,
A.CEP,
A.CIFRA,
A.MES_REF,
A.ANO_REF,
A.NATOPER,
A.R_MONTH,
A.R_YEAR,
A.CURCODE

From WITHTYPE A
--Where A.UNIQUE_FLAG_INVOICE = '1'
